<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NASA APOD ‚Äî Daily & Random (Supercharged)</title>
  <style>
    :root { --bg:#0b1020; --panel:#121936; --accent:#7aa2f7; --text:#eaf0ff; --muted:#9fb0d1; --card: rgba(18,25,54,.65); --border: rgba(255,255,255,.12); --btnGhost: rgba(255,255,255,.18); }
    [data-theme="light"] { --bg:#f5f7ff; --panel:#ffffff; --accent:#2563eb; --text:#0b1020; --muted:#50618a; --card:#ffffff; --border: rgba(11,16,32,.12); --btnGhost: rgba(11,16,32,.18); }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: radial-gradient(1100px 700px at 20% -10%, #19244d 0%, var(--bg) 60%); color: var(--text); }
    header { padding: 18px 22px; border-bottom: 1px solid var(--border); display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; background: linear-gradient(180deg, rgba(255,255,255,.04), transparent); }
    h1 { font-size: clamp(20px, 4vw, 28px); margin: 0; display:flex; align-items:center; gap:10px; }
    main { max-width: 1200px; margin: 0 auto; padding: 18px; display: grid; gap: 18px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:18px; } @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.15); display:flex; flex-direction:column; }
    .media { display:flex; align-items:center; justify-content:center; background:#070b18; } [data-theme="light"] .media { background:#e9eefc; }
    img, iframe { max-width: 100%; width: 100%; height: auto; display:block; }
    .content { padding: 16px; display:grid; gap:10px; }
    .title { font-weight: 800; font-size: 22px; margin: 0; }
    .meta  { color: var(--muted); font-size: 14px; }
    .desc  { line-height: 1.65; font-size: 16px; color: inherit; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row-between { display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
    .btn { background: var(--accent); color:#071024; border:0; border-radius: 999px; padding:10px 14px; cursor:pointer; font-weight:700; }
    .btn.secondary { background: transparent; color: inherit; border:1px solid var(--border); }
    .btn.ghost { background: transparent; color: inherit; border:1px dashed var(--btnGhost); }
    .key { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0f1631; color:#eaf0ff; padding:2px 6px; border-radius:6px; border:1px solid var(--border); } [data-theme="light"] .key { background:#e9eefc; color:#0b1020; }
    a { color: #93c5fd; } [data-theme="light"] a { color:#2563eb; }
    footer { text-align:center; color: var(--muted); font-size:12px; padding: 10px 0 20px; }
    .small { font-size: 12px; color: var(--muted); }
    .pill { padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }
    input[type="date"] { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:transparent; color:inherit; }
    .heart { font-size:18px; cursor:pointer; user-select:none; } .heart.active { filter: drop-shadow(0 0 4px rgba(255,0,80,.6)); }
    .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; }
    .thumb { border:1px solid var(--border); border-radius:10px; overflow: hidden; background:#070b18; } [data-theme="light"] .thumb { background:#e9eefc; }
    .thumb img { width:100%; height:100px; object-fit:cover; display:block; }
    .thumb .label { padding:8px; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .modal { position: fixed; inset: 0; display:none; background: rgba(0,0,0,.6); align-items: center; justify-content: center; padding: 20px; }
    .modal .sheet { width: min(100%, 980px); background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; max-height: 90vh; overflow:auto; }
    .close-x { float:right; cursor:pointer; font-weight:900; font-size:18px; }
  </style>
</head>
<body>
  <header>
    <h1>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 2l1.76 5.41h5.69l-4.6 3.34 1.76 5.41L12 12.82 7.39 16.16l1.76-5.41-4.6-3.34h5.69L12 2z" fill="#ffd166"/></svg>
      NASA APOD ‚Äî Daily & Random
    </h1>
    <div class="toolbar">
      <button id="themeToggle" class="btn secondary" title="Toggle Light/Dark">Toggle Theme</button>
      <button id="shortcutsBtn" class="btn ghost" title="Keyboard shortcuts">Shortcuts (?)</button>
    </div>
  </header>

  <main>
    <section class="card" style="padding: 14px;">
      <div class="row-between">
        <div class="toolbar"><span>API key: <span id="keyLabel" class="key">DEMO_KEY</span></span><span class="pill">No card needed</span></div>
        <div class="toolbar">
          <button id="setKey" class="btn">Set my NASA key</button>
          <button id="useDemo" class="btn secondary">Use DEMO_KEY</button>
          <a class="btn ghost" href="https://api.nasa.gov/" target="_blank" rel="noreferrer">Get a free key</a>
        </div>
      </div>
      <p class="small" style="margin:6px 2px 0;">Your key is stored locally (browser). DEMO_KEY works for light usage.</p>
    </section>

    <div class="grid">
      <section class="card" id="dailyCard">
        <div id="dailyMedia" class="media" aria-live="polite"></div>
        <div class="content">
          <div class="row-between">
            <div class="toolbar">
              <button id="prevDay" class="btn secondary" title="Previous day (‚Üê)">‚Üê Prev</button>
              <input id="dailyDate" type="date"><button id="nextDay" class="btn secondary" title="Next day (‚Üí)">Next ‚Üí</button><button id="gotoToday" class="btn ghost">Today</button>
            </div>
            <div class="toolbar">
              <button id="dailyRefresh" class="btn secondary">Refresh</button>
              <button id="dailyOpenHD" class="btn ghost">Open HD</button>
              <button id="dailyDownload" class="btn ghost">Download</button>
              <button id="dailyFav" class="btn ghost" title="Toggle favorite"><span class="heart" id="dailyHeart">‚ô°</span></button>
              <button id="dailyShare" class="btn ghost" title="Copy link">Share</button>
              <button id="compareBtn" class="btn ghost" title="Compare two dates">Compare</button>
            </div>
          </div>
          <div id="dailyInfo" class="meta">Pick a date or view today‚Äôs APOD.</div>
          <h2 id="dailyTitle" class="title"></h2>
          <div id="dailyExplanation" class="desc"></div>
        </div>
      </section>

      <section class="card" id="randomCard">
        <div id="randomMedia" class="media" aria-live="polite"></div>
        <div class="content">
          <div class="row-between">
            <div class="toolbar">
              <button id="randomReroll" class="btn" title="Get a random APOD (R)">Re-roll üîÑ</button>
              <label style="display:flex; align-items:center; gap:6px;">Auto <select id="autoMode"><option value="off">Off</option><option value="random">Random</option><option value="latest">Latest ‚Üí Past</option></select></label>
              <label style="display:flex; align-items:center; gap:6px;">Every <input id="autoSecs" type="number" min="2" max="120" value="6" style="width:70px;"> s</label>
              <button id="autoStart" class="btn secondary">Start</button><button id="autoStop" class="btn secondary">Stop</button>
            </div>
            <div class="toolbar">
              <button id="randomBack" class="btn secondary">‚üµ Back</button><button id="randomFwd" class="btn secondary">Forward ‚ü∂</button>
              <button id="randomOpenHD" class="btn ghost">Open HD</button><button id="randomDownload" class="btn ghost">Download</button>
              <button id="randomFav" class="btn ghost" title="Toggle favorite"><span class="heart" id="randomHeart">‚ô°</span></button>
              <button id="randomShare" class="btn ghost" title="Copy link">Share</button>
            </div>
          </div>
          <div id="randomInfo" class="meta">Click ‚ÄúRe-roll‚Äù to get a random APOD.</div>
          <h2 id="randomTitle" class="title"></h2>
          <div id="randomExplanation" class="desc"></div>
        </div>
      </section>
    </div>

    <section class="card" id="favsCard" style="padding:16px;">
      <div class="row-between"><h2 class="title" style="margin:0;">‚≠ê Favorites</h2>
        <div class="toolbar"><button id="exportFavs" class="btn secondary">Export JSON</button><button id="importFavs" class="btn ghost">Import JSON</button><button id="clearFavs" class="btn ghost">Clear</button></div>
      </div>
      <div id="favsGallery" class="gallery" style="margin-top:12px;"></div>
      <p class="small">Favorites are saved locally. Click a thumbnail to open that APOD.</p>
    </section>
  </main>

  <footer>Data courtesy of NASA APOD. Some entries are videos; we embed when possible or show a link/thumbnail.</footer>

  <div id="shortcutsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle">
    <div class="sheet"><span class="close-x" id="shortcutsClose">‚úï</span><h3 id="shortcutsTitle" class="title">Keyboard Shortcuts</h3>
      <ul><li>‚Üê/‚Üí : Previous/Next day (Daily)</li><li>T : Today (Daily)</li><li>R : Re-roll Random</li><li>F : Favorite current</li><li>S : Start/Stop Auto</li><li>? : Toggle this help</li></ul>
    </div>
  </div>

  <div id="compareModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="compareTitle">
    <div class="sheet"><span class="close-x" id="compareClose">‚úï</span><h3 id="compareTitle" class="title">Compare Two Dates</h3>
      <div class="toolbar" style="margin-bottom:10px;"><label>Left <input id="cmpDateA" type="date"></label><label>Right <input id="cmpDateB" type="date"></label><button id="cmpLoad" class="btn">Load</button></div>
      <div class="grid" id="cmpGrid">
        <section class="card"><div id="cmpMediaA" class="media"></div><div class="content"><div id="cmpInfoA" class="meta"></div><div id="cmpTitleA" class="title"></div><div id="cmpExplA" class="desc"></div></div></section>
        <section class="card"><div id="cmpMediaB" class="media"></div><div class="content"><div id="cmpInfoB" class="meta"></div><div id="cmpTitleB" class="title"></div><div id="cmpExplB" class="desc"></div></div></section>
      </div>
    </div>
  </div>

<script>
  const KEY_STORAGE = "nasa_api_key"; const THEME_STORAGE = "apod_theme";
  let API_KEY = localStorage.getItem(KEY_STORAGE) || "DEMO_KEY"; document.getElementById("keyLabel").textContent = API_KEY;
  const savedTheme = localStorage.getItem(THEME_STORAGE) || "dark"; document.documentElement.setAttribute("data-theme", savedTheme);
  document.getElementById("themeToggle").addEventListener("click", () => { const t = document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark"; document.documentElement.setAttribute("data-theme", t); localStorage.setItem(THEME_STORAGE, t); });
  document.getElementById("setKey").addEventListener("click", () => { const v = prompt("Paste your NASA API key:", API_KEY==="DEMO_KEY"?"":API_KEY); if (v&&v.trim()){ API_KEY=v.trim(); localStorage.setItem(KEY_STORAGE, API_KEY); document.getElementById("keyLabel").textContent = API_KEY; loadDaily(); if(randomState.apod) showRandom(randomState.apod);} });
  document.getElementById("useDemo").addEventListener("click", () => { API_KEY="DEMO_KEY"; localStorage.setItem(KEY_STORAGE, API_KEY); document.getElementById("keyLabel").textContent = API_KEY; loadDaily(); if(randomState.apod) showRandom(randomState.apod); });

  function fmtDate(d){ const dt=(d&&!isNaN(Date.parse(d)))?new Date(d):new Date(); return dt.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}); }
  function isoToday(){ const t=new Date(); const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0"); return `${y}-${m}-${d}`; }
  function bestImageUrl(apod){ return apod.hdurl || apod.url || apod.thumbnail_url || null; }
  function renderMedia(apod, el){ el.innerHTML=""; if(apod.media_type==="image"){ const img=new Image(); img.alt=apod.title||"APOD image"; img.loading="lazy"; img.src=bestImageUrl(apod); el.appendChild(img); } else if(apod.media_type==="video"){ const can=/youtube|vimeo|player/.test(apod.url); if(can){ const ifr=document.createElement("iframe"); ifr.src=apod.url; ifr.allowFullscreen=true; ifr.loading="lazy"; ifr.style.aspectRatio="16/9"; el.appendChild(ifr);} else { const a=document.createElement("a"); a.href=apod.url; a.target="_blank"; a.rel="noreferrer"; a.textContent="Open APOD video"; el.appendChild(a); if(apod.thumbnail_url){ const img=new Image(); img.src=apod.thumbnail_url; img.alt="Video thumbnail"; img.style.marginTop="8px"; el.appendChild(img); } } } else { el.textContent="Unsupported media type."; } }
  async function fetchAPODDate(dateStr){ const u=new URL("https://api.nasa.gov/planetary/apod"); u.searchParams.set("api_key",API_KEY); u.searchParams.set("thumbs","true"); if(dateStr) u.searchParams.set("date",dateStr); const r=await fetch(u); if(!r.ok) throw new Error("APOD fetch failed: "+r.status); return r.json(); }
  async function fetchAPODRandom(){ const u=new URL("https://api.nasa.gov/planetary/apod"); u.searchParams.set("api_key",API_KEY); u.searchParams.set("thumbs","true"); u.searchParams.set("count","1"); const r=await fetch(u); if(!r.ok) throw new Error("APOD random fetch failed: "+r.status); const arr=await r.json(); return Array.isArray(arr)?arr[0]:arr; }

  const FAVS_KEY="apod_favs_v1"; let favorites=[];
  function loadFavs(){ try{ favorites=JSON.parse(localStorage.getItem(FAVS_KEY)||"[]"); } catch{ favorites=[]; } }
  function saveFavs(){ localStorage.setItem(FAVS_KEY, JSON.stringify(favorites)); }
  function isFav(date){ return favorites.some(f=>f.date===date); }
  function toggleFav(apod){ const i=favorites.findIndex(f=>f.date===apod.date); if(i>=0) favorites.splice(i,1); else favorites.unshift({date:apod.date,title:apod.title,media_type:apod.media_type,url:apod.url||null,hdurl:apod.hdurl||null,thumbnail_url:apod.thumbnail_url||null}); saveFavs(); renderFavs(); updateHeartUI(); }
  function renderFavs(){ const wrap=document.getElementById("favsGallery"); wrap.innerHTML=""; for(const f of favorites){ const div=document.createElement("div"); div.className="thumb"; const src=f.thumbnail_url||f.hdurl||f.url; div.innerHTML=`<img alt="thumb"><div class="label">${f.title||f.date}</div>`; const img=div.querySelector("img"); img.src=src; img.alt=f.title||f.date; div.addEventListener("click", async()=>{ dailyDate.value=f.date; await loadDaily(); window.scrollTo({top:0,behavior:"smooth"}); }); wrap.appendChild(div);} }
  document.getElementById("exportFavs").addEventListener("click", ()=>{ const blob=new Blob([JSON.stringify(favorites,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="apod-favorites.json"; a.click(); URL.revokeObjectURL(url); });
  document.getElementById("importFavs").addEventListener("click", ()=>{ const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json"; inp.onchange=()=>{ const f=inp.files?.[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const arr=JSON.parse(rd.result); if(Array.isArray(arr)){ favorites=arr; saveFavs(); renderFavs(); } else alert("Invalid JSON."); } catch(e){ alert("Import failed: "+e.message); } }; rd.readAsText(f); }; inp.click(); });
  document.getElementById("clearFavs").addEventListener("click", ()=>{ if(!confirm("Clear all favorites?")) return; favorites=[]; saveFavs(); renderFavs(); updateHeartUI(); });

  const dailyInfo=document.getElementById("dailyInfo"), dailyMedia=document.getElementById("dailyMedia"), dailyTitle=document.getElementById("dailyTitle"), dailyExpl=document.getElementById("dailyExplanation"), dailyDate=document.getElementById("dailyDate"), dailyHeart=document.getElementById("dailyHeart");
  async function loadDaily(){ try{ dailyInfo.textContent="Loading‚Ä¶"; dailyTitle.textContent=""; dailyExpl.textContent=""; dailyMedia.innerHTML=""; const apod=await fetchAPODDate(dailyDate.value||undefined); dailyState.apod=apod; renderMedia(apod,dailyMedia); dailyTitle.textContent=apod.title||"Untitled"; dailyExpl.textContent=apod.explanation||""; dailyInfo.textContent=`${fmtDate(apod.date)} ‚Ä¢ ¬© NASA/APOD`; const u=new URL(location.href); u.searchParams.set("date", apod.date); history.replaceState({}, "", u); updateHeartUI(); } catch(e){ dailyInfo.textContent="‚Äî"; dailyTitle.textContent="Error loading APOD"; dailyExpl.textContent=e.message; } }
  function updateHeartUI(){ dailyHeart.textContent=(dailyState.apod&&isFav(dailyState.apod.date))?"‚ô•":"‚ô°"; dailyHeart.classList.toggle("active", dailyState.apod&&isFav(dailyState.apod.date)); randomHeart.textContent=(randomState.apod&&isFav(randomState.apod.date))?"‚ô•":"‚ô°"; randomHeart.classList.toggle("active", randomState.apod&&isFav(randomState.apod.date)); }
  document.getElementById("dailyRefresh").addEventListener("click", loadDaily);
  document.getElementById("prevDay").addEventListener("click", ()=>stepDay(-1)); document.getElementById("nextDay").addEventListener("click", ()=>stepDay(1));
  document.getElementById("gotoToday").addEventListener("click", ()=>{ dailyDate.value=isoToday(); loadDaily(); });
  dailyDate.addEventListener("change", loadDaily);
  function stepDay(delta){ const d=new Date(dailyDate.value||isoToday()); d.setDate(d.getDate()+delta); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); dailyDate.value=`${y}-${m}-${dd}`; loadDaily(); }
  document.getElementById("dailyOpenHD").addEventListener("click", ()=>{ const url=dailyState.apod&&bestImageUrl(dailyState.apod); if(!url) return alert("No image to open (may be a video)."); window.open(url,"_blank","noreferrer"); });
  document.getElementById("dailyDownload").addEventListener("click", ()=>{ const url=dailyState.apod&&bestImageUrl(dailyState.apod); if(!url) return alert("No downloadable image."); const a=document.createElement("a"); a.href=url; a.download=((dailyState.apod.title||"apod")+".jpg").replace(/[^a-z0-9\-_]+/gi,"_"); document.body.appendChild(a); a.click(); a.remove(); });
  document.getElementById("dailyFav").addEventListener("click", ()=>{ if(dailyState.apod) toggleFav(dailyState.apod); });
  document.getElementById("dailyShare").addEventListener("click", async()=>{ const u=new URL(location.href); if(dailyState.apod?.date) u.searchParams.set("date", dailyState.apod.date); await navigator.clipboard.writeText(u.toString()); alert("Link copied!"); });

  const compareModal=document.getElementById("compareModal"), compareBtn=document.getElementById("compareBtn"), cmpClose=document.getElementById("compareClose"), cmpDateA=document.getElementById("cmpDateA"), cmpDateB=document.getElementById("cmpDateB"), cmpLoad=document.getElementById("cmpLoad");
  compareBtn.addEventListener("click", ()=>{ cmpDateA.value=dailyDate.value||isoToday(); cmpDateB.value=""; compareModal.style.display="flex"; });
  cmpClose.addEventListener("click", ()=>compareModal.style.display="none");
  cmpLoad.addEventListener("click", async()=>{ await Promise.all([ (async()=>{ const a=await fetchAPODDate(cmpDateA.value); renderMedia(a, document.getElementById("cmpMediaA")); document.getElementById("cmpInfoA").textContent=fmtDate(a.date); document.getElementById("cmpTitleA").textContent=a.title||""; document.getElementById("cmpExplA").textContent=a.explanation||""; })(), (async()=>{ const b=await fetchAPODDate(cmpDateB.value); renderMedia(b, document.getElementById("cmpMediaB")); document.getElementById("cmpInfoB").textContent=fmtDate(b.date); document.getElementById("cmpTitleB").textContent=b.title||""; document.getElementById("cmpExplB").textContent=b.explanation||""; })() ]); });
  compareModal.addEventListener("click", (e)=>{ if(e.target===compareModal) compareModal.style.display="none"; });

  const randomInfo=document.getElementById("randomInfo"), randomMedia=document.getElementById("randomMedia"), randomTitle=document.getElementById("randomTitle"), randomExpl=document.getElementById("randomExplanation"), randomHeart=document.getElementById("randomHeart");
  const autoMode=document.getElementById("autoMode"), autoSecs=document.getElementById("autoSecs"), autoStart=document.getElementById("autoStart"), autoStop=document.getElementById("autoStop");
  let randomHistory=[], randomIndex=-1, autoTimer=null;
  function showRandom(apod){ randomState.apod=apod; renderMedia(apod,randomMedia); randomTitle.textContent=apod.title||"Untitled"; randomExpl.textContent=apod.explanation||""; randomInfo.textContent=`${fmtDate(apod.date)} ‚Ä¢ ¬© NASA/APOD`; updateHeartUI(); }
  async function rerollRandom(push=true){ try{ randomInfo.textContent="Loading random APOD‚Ä¶"; randomTitle.textContent=""; randomExpl.textContent=""; randomMedia.innerHTML=""; let apod; if(autoMode.value==="latest"){ const d=new Date(isoToday()); d.setDate(d.getDate()-Math.max(0,randomHistory.length)); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); apod=await fetchAPODDate(`${y}-${m}-${dd}`); } else { apod=await fetchAPODRandom(); } showRandom(apod); if(push){ if(randomIndex < randomHistory.length-1) randomHistory = randomHistory.slice(0, randomIndex+1); randomHistory.push(apod); randomIndex=randomHistory.length-1; } } catch(e){ randomInfo.textContent="‚Äî"; randomTitle.textContent="Error loading random APOD"; randomExpl.textContent=e.message; } }
  document.getElementById("randomReroll").addEventListener("click", ()=>rerollRandom(true));
  document.getElementById("randomBack").addEventListener("click", ()=>{ if(randomIndex>0){ randomIndex-=1; showRandom(randomHistory[randomIndex]); } });
  document.getElementById("randomFwd").addEventListener("click", ()=>{ if(randomIndex<randomHistory.length-1){ randomIndex+=1; showRandom(randomHistory[randomIndex]); } });
  document.getElementById("randomOpenHD").addEventListener("click", ()=>{ const url=randomState.apod&&bestImageUrl(randomState.apod); if(!url) return alert("No image to open (may be a video)."); window.open(url,"_blank","noreferrer"); });
  document.getElementById("randomDownload").addEventListener("click", ()=>{ const url=randomState.apod&&bestImageUrl(randomState.apod); if(!url) return alert("No downloadable image."); const a=document.createElement("a"); a.href=url; a.download=((randomState.apod.title||"apod")+".jpg").replace(/[^a-z0-9\-_]+/gi,"_"); document.body.appendChild(a); a.click(); a.remove(); });
  document.getElementById("randomFav").addEventListener("click", ()=>{ if(randomState.apod) toggleFav(randomState.apod); });
  document.getElementById("randomShare").addEventListener("click", async()=>{ const u=new URL(location.href); u.searchParams.delete("date"); u.searchParams.set("random","1"); await navigator.clipboard.writeText(u.toString()); alert("Random link copied!"); });
  autoStart.addEventListener("click", ()=>{ const secs=Math.max(2, Math.min(120, parseInt(autoSecs.value||"6",10))); clearInterval(autoTimer); autoTimer=setInterval(()=>rerollRandom(true), secs*1000); alert("Auto mode started."); });
  autoStop.addEventListener("click", ()=>{ clearInterval(autoTimer); autoTimer=null; alert("Auto mode stopped."); });

  const shortcutsModal=document.getElementById("shortcutsModal"); document.getElementById("shortcutsBtn").addEventListener("click", ()=>shortcutsModal.style.display="flex"); document.getElementById("shortcutsClose").addEventListener("click", ()=>shortcutsModal.style.display="none"); shortcutsModal.addEventListener("click",(e)=>{ if(e.target===shortcutsModal) shortcutsModal.style.display="none"; });
  window.addEventListener("keydown", (e)=>{ const tag=(e.target.tagName||"").toLowerCase(); if(tag==="input"||tag==="textarea") return; if(e.key==="?"){ shortcutsModal.style.display=shortcutsModal.style.display==="flex"?"none":"flex"; } if(e.key==="ArrowLeft") stepDay(-1); if(e.key==="ArrowRight") stepDay(1); if(e.key.toLowerCase()==="t"){ dailyDate.value=isoToday(); loadDaily(); } if(e.key.toLowerCase()==="r") rerollRandom(true); if(e.key.toLowerCase()==="f"){ if(document.activeElement.closest("#dailyCard")){ if(dailyState.apod) toggleFav(dailyState.apod); } else if(document.activeElement.closest("#randomCard")){ if(randomState.apod) toggleFav(randomState.apod); } else { if(randomState.apod) toggleFav(randomState.apod); } } if(e.key.toLowerCase()==="s"){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } else { const secs=Math.max(2, Math.min(120, parseInt(autoSecs.value||"6",10))); autoTimer=setInterval(()=>rerollRandom(true), secs*1000); } } });

  let dailyState={apod:null}; let randomState={apod:null};
  let params=new URLSearchParams(location.search); const initialDate=params.get("date"); const initialRandom=params.get("random")==="1";
  loadFavs(); renderFavs(); dailyDate.value=initialDate||isoToday(); loadDaily().then(()=>{ if(initialRandom) rerollRandom(true); else rerollRandom(true); });
</script>
</body>
</html>

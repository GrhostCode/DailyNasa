<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Space Hub ‚Äî NASA + SpaceX + Weather + Accounts</title>

<!-- Leaflet (for ISS map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhYJ4k6kG6su2Vh8qR2v3Q2jPz9F2aPM3sWQ=" crossorigin=""/>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-7Q9nBVrS7400N3YQzUytQM5bZ8G8ZbyqYjQf2SYL3jY=" crossorigin=""></script>

<!-- Suncalc (moon phase / sun times) -->
<script defer src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
  :root{--bg:#0b1020;--card:#121936cc;--text:#eaf0ff;--muted:#9fb0d1;--accent:#7aa2f7;--border:#ffffff1e}
  [data-theme="light"]{--bg:#f5f7ff;--card:#ffffff;--text:#0b1020;--muted:#4b5b86;--accent:#2563eb;--border:#0b10202a}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1000px 600px at 20% -10%,#19244d 0%,var(--bg) 60%);color:var(--text)}
  header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:20px;margin:0;display:flex;gap:10px;align-items:center}
  .btn{background:var(--accent);color:#061022;border:0;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn.secondary{background:transparent;color:inherit;border:1px solid var(--border)}
  .btn.ghost{background:transparent;border:1px dashed var(--border);color:inherit}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
  main{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px #0004;overflow:hidden}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 12px;border:1px solid var(--border);border-radius:999px;background:transparent;color:inherit;cursor:pointer}
  .tab.active{background:var(--accent);color:#061022;border:0}
  .panel{display:none}
  .panel.active{display:block}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .media{display:flex;align-items:center;justify-content:center;background:#060a18}
  [data-theme="light"] .media{background:#e9eefc}
  img,iframe,video{max-width:100%;width:100%;height:auto;display:block}
  .content{padding:14px;display:grid;gap:10px}
  .title{font-weight:800;margin:0}
  .meta{color:var(--muted);font-size:14px}
  .grid2{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:980px){.grid2{grid-template-columns:1fr 1fr}}
  input,select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:inherit}
  label{display:flex;gap:6px;align-items:center}
  .key{font-family:ui-monospace,Menlo,Consolas,monospace;padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
  .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .thumb{border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#070b18;cursor:pointer}
  [data-theme="light"] .thumb{background:#e9eefc}
  .thumb img{width:100%;height:100px;object-fit:cover;display:block}
  .thumb .label{padding:8px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  footer{color:var(--muted);text-align:center;font-size:12px;padding:10px 0 20px}

  /* ISS map */
  #issMap { width:100%; height:420px; }
</style>
</head>
<body>
<header>
  <h1>üõ∞Ô∏è Space Hub</h1>
  <div class="row">
    <span class="pill" id="themeState">Dark</span>
    <button class="btn secondary" id="toggleTheme" title="g">Toggle Theme</button>
  </div>
</header>

<main>
  <!-- Account + Keys card -->
  <section class="card" style="padding:12px">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <strong id="acctStatus">Not signed in</strong>
        <span class="pill">Accounts by Firebase (no backend code)</span>
      </div>
      <div class="row">
        <button id="signIn" class="btn">Sign in with Google</button>
        <button id="signOut" class="btn secondary" style="display:none">Sign out</button>
      </div>
    </div>
    <hr style="border-color:var(--border);opacity:.3">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span>NASA key: <span id="nasaKeyLbl" class="key">DEMO_KEY</span></span>
        <span class="pill">No card needed</span>
      </div>
      <div class="row">
        <button id="setNasaKey" class="btn">Set NASA key</button>
        <button id="useDemo" class="btn secondary">Use DEMO_KEY</button>
        <a class="btn ghost" href="https://api.nasa.gov/" target="_blank" rel="noreferrer">Get NASA key</a>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <span>Unsplash key: <span id="unsplashKeyLbl" class="key">unset</span></span>
      <button id="setUnsplashKey" class="btn secondary">Set Unsplash key</button>
      <a class="btn ghost" href="https://unsplash.com/developers" target="_blank" rel="noreferrer">Get Unsplash key</a>
    </div>
    <p class="meta" style="margin:6px 2px 0">Keys & favorites are saved to your account when signed in; otherwise stored locally in your browser.</p>
  </section>

  <!-- Tabs -->
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="apod">APOD</button>
    <button class="tab" data-tab="mars">Mars Rover</button>
    <button class="tab" data-tab="epic">EPIC Earth</button>
    <button class="tab" data-tab="spacex">SpaceX</button>
    <button class="tab" data-tab="weather">Weather</button>
    <button class="tab" data-tab="iss">ISS</button>
    <button class="tab" data-tab="sky">Sky</button>
    <button class="tab" data-tab="unsplash">Unsplash</button>
    <button class="tab" data-tab="account">Account</button>
  </div>

  <!-- APOD -->
  <section id="apod" class="panel active">
    <div class="grid2">
      <!-- Daily -->
      <section class="card">
        <div id="apodDailyMedia" class="media"></div>
        <div class="content">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <div id="apodDailyInfo" class="meta">Loading today‚Ä¶</div>
            </div>
            <div class="row">
              <input type="date" id="apodDate" title="Pick a date"/>
              <button id="apodDailyRefresh" class="btn secondary">Refresh</button>
              <button id="apodDailyFav" class="btn ghost" title="f">‚ô° Favorite</button>
              <button id="apodDailyShare" class="btn ghost">Share</button>
              <button id="apodDailyOpen" class="btn ghost">Open HD</button>
              <button id="apodDailyDL" class="btn" title="d">Download</button>
            </div>
          </div>
          <h3 id="apodDailyTitle" class="title"></h3>
          <div id="apodDailyExpl" class="meta"></div>
          <div class="meta" id="apodDailyMsg"></div>
        </div>
      </section>

      <!-- Random -->
      <section class="card">
        <div id="apodRndMedia" class="media"></div>
        <div class="content">
          <div class="row" style="justify-content:space-between">
            <div id="apodRndInfo" class="meta">Click Re-roll</div>
            <div class="row">
              <button id="apodRndReroll" class="btn" title="r">Re-roll üîÑ</button>
              <button id="apodRndAuto" class="btn secondary">Auto: Off</button>
              <button id="apodRndFav" class="btn ghost" title="f">‚ô° Favorite</button>
              <button id="apodRndShare" class="btn ghost">Share</button>
              <button id="apodRndOpen" class="btn ghost">Open HD</button>
              <button id="apodRndDL" class="btn" title="d">Download</button>
            </div>
          </div>
          <h3 id="apodRndTitle" class="title"></h3>
          <div id="apodRndExpl" class="meta"></div>
          <div class="meta" id="apodRndMsg"></div>
        </div>
      </section>
    </div>

    <!-- Recent APOD gallery -->
    <section class="card" style="margin-top:14px;padding:14px">
      <div class="row" style="justify-content:space-between">
        <h3 class="title" style="margin:0">üóìÔ∏è Recent APOD (last 8 days)</h3>
        <div class="row">
          <button id="apodRecentReload" class="btn secondary">Reload</button>
        </div>
      </div>
      <div id="apodRecentGrid" class="gallery" style="margin-top:10px"></div>
      <p class="meta">Click a thumbnail to open HD in a new tab. Alt+Click to favorite quickly.</p>
    </section>

    <!-- Favorites gallery -->
    <section class="card" style="margin-top:14px;padding:14px">
      <div class="row" style="justify-content:space-between">
        <h3 class="title" style="margin:0">‚≠ê Favorites</h3>
        <div class="row">
          <button id="favExport" class="btn secondary">Export JSON</button>
          <button id="favImport" class="btn ghost">Import JSON</button>
          <button id="favClear" class="btn ghost">Clear All</button>
          <button id="favSync" class="btn">Sync Now</button>
        </div>
      </div>
      <div id="favGrid" class="gallery" style="margin-top:10px"></div>
      <p class="meta">Open item on click. Alt+Click to remove from favorites.</p>
    </section>
  </section>

  <!-- Mars Rover -->
  <section id="mars" class="panel">
    <section class="card">
      <div class="content">
        <div class="row">
          <label>Rover
            <select id="rover">
              <option>curiosity</option>
              <option>perseverance</option>
              <option>opportunity</option>
              <option>spirit</option>
            </select>
          </label>
          <label>Sol <input id="sol" type="number" min="0" value="1000"/></label>
          <label>Camera
            <select id="camera">
              <option value="">Any</option>
              <option value="FHAZ">FHAZ</option>
              <option value="RHAZ">RHAZ</option>
              <option value="NAVCAM">NAVCAM</option>
              <option value="MAST">MAST</option>
              <option value="PANCAM">PANCAM</option>
              <option value="CHEMCAM">CHEMCAM</option>
            </select>
          </label>
          <button id="marsLoad" class="btn">Load</button>
          <button id="marsPrev" class="btn secondary">Sol -1</button>
          <button id="marsNext" class="btn secondary">Sol +1</button>
        </div>
      </div>
      <div id="marsMedia" class="media"></div>
      <div class="content">
        <div id="marsInfo" class="meta">‚Äî</div>
      </div>
    </section>
  </section>

  <!-- EPIC Earth -->
  <section id="epic" class="panel">
    <section class="card">
      <div class="content">
        <div class="row">
          <label>Date <input type="date" id="epicDate"/></label>
          <button id="epicLoad" class="btn">Load</button>
        </div>
        <div id="epicInfo" class="meta">Pick a date with images.</div>
      </div>
      <div id="epicMedia" class="media"></div>
      <div class="content">
        <div class="row">
          <button id="epicPrev" class="btn secondary">Prev</button>
          <button id="epicNext" class="btn secondary">Next</button>
          <button id="epicDL" class="btn">Download current</button>
        </div>
      </div>
    </section>
  </section>

  <!-- SpaceX -->
  <section id="spacex" class="panel">
    <section class="card">
      <div class="content">
        <div class="row">
          <button id="sxUpcoming" class="btn">Load Upcoming</button>
          <button id="sxLatest" class="btn secondary">Latest Launch</button>
        </div>
      </div>
      <div class="content" id="sxList"></div>
    </section>
  </section>

  <!-- Weather -->
  <section id="weather" class="panel">
    <section class="card">
      <div class="content">
        <div class="row">
          <label>Location <input id="wxQuery" placeholder="e.g., San Juan, PR"/></label>
          <button id="wxGo" class="btn">Get Weather</button>
        </div>
        <div id="wxInfo" class="meta">Powered by Open-Meteo & OpenStreetMap (no keys).</div>
      </div>
      <div class="content">
        <div id="wxNow" class="title"></div>
        <div id="wxHourly" class="meta"></div>
      </div>
    </section>
  </section>

  <!-- ISS live -->
  <section id="iss" class="panel">
    <section class="card">
      <div class="content">
        <div class="row" style="justify-content:space-between">
          <strong>üõ∞Ô∏è ISS Live Position</strong>
          <div class="row">
            <button id="issStart" class="btn">Start</button>
            <button id="issStop" class="btn secondary">Stop</button>
          </div>
        </div>
        <div class="meta" id="issInfo">Updates every ~5s</div>
      </div>
      <div id="issMap"></div>
    </section>
  </section>

  <!-- Sky helper -->
  <section id="sky" class="panel">
    <section class="card">
      <div class="content">
        <div class="row">
          <label>Where <input id="skyWhere" placeholder="San Juan, PR"/></label>
          <button id="skyGo" class="btn">Compute</button>
        </div>
        <div id="skyInfo" class="meta">Shows moon phase and sun rise/set with Suncalc (no keys).</div>
      </div>
      <div class="content" id="skyOut"></div>
    </section>
  </section>

  <!-- Unsplash -->
  <section id="unsplash" class="panel">
    <section class="card">
      <div class="content">
        <div class="row">
          <label>Query <input id="usQuery" placeholder="nebula, galaxy, rocket"/></label>
          <button id="usRandom" class="btn">Random Photo</button>
          <button id="usDL" class="btn secondary">Download</button>
        </div>
        <div id="usInfo" class="meta">Requires Unsplash access key (free). Set it above.</div>
      </div>
      <div id="usMedia" class="media"></div>
      <div class="content">
        <div id="usCredit" class="meta"></div>
      </div>
    </section>
  </section>

  <!-- Account tab -->
  <section id="account" class="panel">
    <section class="card">
      <div class="content">
        <h3 class="title" style="margin:0">Account</h3>
        <div class="meta" id="acctDetail">Sign in to sync keys & favorites across devices.</div>
      </div>
    </section>
  </section>
</main>

<footer>Data: NASA, SpaceX, Open-Meteo, OSM, Unsplash. Auth & DB: Firebase (free tier).</footer>

<!-- Main app (module) -->
<script type="module">
/*** THEME ***/
const themeKey="spacehub_theme";
const themeState=document.getElementById("themeState");
function setTheme(t){document.documentElement.setAttribute("data-theme",t); localStorage.setItem(themeKey,t); themeState.textContent=t[0].toUpperCase()+t.slice(1);}
setTheme(localStorage.getItem(themeKey)||"dark");
document.getElementById("toggleTheme").onclick=()=>setTheme(document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark");

/*** TABS ***/
document.querySelectorAll(".tab").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    b.classList.add("active");
    document.getElementById(b.dataset.tab).classList.add("active");
  };
});

/*** LOCAL STORAGE FALLBACK ***/
const LS = {
  nasaKey: ()=>localStorage.getItem("nasa_api_key")||"DEMO_KEY",
  setNasaKey: v=>localStorage.setItem("nasa_api_key", v),
  unsplashKey: ()=>localStorage.getItem("unsplash_api_key")||"",
  setUnsplashKey: v=>localStorage.setItem("unsplash_api_key", v),
  favs: ()=>JSON.parse(localStorage.getItem("apod_favs_v1")||"[]"),
  setFavs: arr=>localStorage.setItem("apod_favs_v1", JSON.stringify(arr)),
};

/*** STATE ***/
let NASA_KEY = LS.nasaKey();
let UNSPLASH_KEY = LS.unsplashKey();
let FAVS = LS.favs(); // [{date,title,media_type,url,hdurl,thumbnail_url}]
let USER = null;

/*** UI: KEYS ***/
const nasaKeyLbl=document.getElementById("nasaKeyLbl");
const unsplashKeyLbl=document.getElementById("unsplashKeyLbl");
nasaKeyLbl.textContent = NASA_KEY;
unsplashKeyLbl.textContent = UNSPLASH_KEY || "unset";
document.getElementById("setNasaKey").onclick=()=>{ const v=prompt("Enter NASA API key:", NASA_KEY==="DEMO_KEY"?"":NASA_KEY); if(v&&v.trim()){NASA_KEY=v.trim(); LS.setNasaKey(NASA_KEY); nasaKeyLbl.textContent=NASA_KEY; loadAPODDaily(); rerollAPOD(); loadRecentAPOD(); saveProfile(); }};
document.getElementById("useDemo").onclick=()=>{ NASA_KEY="DEMO_KEY"; LS.setNasaKey(NASA_KEY); nasaKeyLbl.textContent=NASA_KEY; loadAPODDaily(); rerollAPOD(); loadRecentAPOD(); saveProfile(); };
document.getElementById("setUnsplashKey").onclick=()=>{ const v=prompt("Enter Unsplash access key:", UNSPLASH_KEY||""); if(v&&v.trim()){UNSPLASH_KEY=v.trim(); LS.setUnsplashKey(UNSPLASH_KEY); unsplashKeyLbl.textContent=UNSPLASH_KEY; saveProfile(); }};
// Hide Unsplash tab if no key
function refreshUnsplashVisibility(){
  const tab=document.querySelector('.tab[data-tab="unsplash"]');
  const panel=document.getElementById('unsplash');
  if(!UNSPLASH_KEY){ tab?.classList.add('hidden'); panel?.classList.add('hidden'); } else { tab?.classList.remove('hidden'); panel?.classList.remove('hidden'); }
}
refreshUnsplashVisibility();

/*** HELPERS ***/
const fmtDate = d => new Date(d).toLocaleString(undefined,{year:'numeric',month:'long',day:'numeric'});
const bestImg = apod => apod.hdurl||apod.url||apod.thumbnail_url||null;

// robust downloader: try blob, fallback to just opening
async function downloadFile(url, filename, msgEl){
  try{
    const res = await fetch(url, {mode:"cors"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const blob = await res.blob();
    const a = document.createElement("a");
    const ext = (()=>{const t=blob.type||''; if(t.includes("png")) return ".png"; if(t.includes("gif")) return ".gif"; if(t.includes("webp")) return ".webp"; return ".jpg";})();
    a.href = URL.createObjectURL(blob);
    a.download = (filename || "download").replace(/[^a-z0-9\-_]+/gi,"_") + ext;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    if(msgEl) msgEl.textContent = "Downloaded ‚úÖ";
  }catch(e){
    // fallback: open in new tab with download attribute
    const a=document.createElement("a");
    a.href=url; a.target="_blank"; a.rel="noreferrer";
    a.download=(filename||"download").replace(/[^a-z0-9\-_]+/gi,"_");
    document.body.appendChild(a); a.click(); a.remove();
    if(msgEl) msgEl.textContent = "Opened image (download fallback).";
  }
}

function renderMedia(container, item){
  container.innerHTML="";
  if(!item){container.textContent="No media.";return;}
  if(item.media_type==="video" || /youtube|vimeo|player/.test(item.url||"")){
    const ifr=document.createElement("iframe");
    ifr.src=item.url; ifr.allowFullscreen=true; ifr.loading="lazy"; ifr.style.aspectRatio="16/9";
    container.appendChild(ifr);
  } else {
    const img=new Image(); img.loading="lazy"; img.alt=item.title||"image"; img.src=bestImg(item)||item.image||item.url;
    container.appendChild(img);
  }
}

/*** APOD (Daily + Random + Favorites) ***/
async function apodFetch(params={}){
  const u=new URL("https://api.nasa.gov/planetary/apod");
  u.searchParams.set("api_key",NASA_KEY);
  u.searchParams.set("thumbs","true");
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r=await fetch(u);
  if(!r.ok) throw new Error("APOD error: "+r.status);
  return r.json();
}

/* Daily */
const apodDailyMedia=document.getElementById("apodDailyMedia"),
      apodDailyInfo=document.getElementById("apodDailyInfo"),
      apodDailyTitle=document.getElementById("apodDailyTitle"),
      apodDailyExpl=document.getElementById("apodDailyExpl"),
      apodDailyMsg=document.getElementById("apodDailyMsg"),
      apodDate=document.getElementById("apodDate");
let apodDaily=null;

async function loadAPODDaily(dateStr){
  apodDailyInfo.textContent="Loading‚Ä¶"; apodDailyTitle.textContent=""; apodDailyExpl.textContent=""; apodDailyMedia.innerHTML=""; apodDailyMsg.textContent="";
  try{
    const p = dateStr ? {date: dateStr} : {};
    const apod=await apodFetch(p);
    apodDaily=apod;
    renderMedia(apodDailyMedia, apod);
    apodDailyInfo.textContent=`${fmtDate(apod.date)} ‚Ä¢ ¬© NASA/APOD`;
    apodDailyTitle.textContent=apod.title||"";
    apodDailyExpl.textContent=apod.explanation||"";
    apodDate.value = apod.date || "";
  }catch(e){ apodDailyInfo.textContent=e.message||"Failed"; }
}
document.getElementById("apodDailyRefresh").onclick=()=>loadAPODDaily(apodDate.value || undefined);
apodDate.onchange = ()=> loadAPODDaily(apodDate.value || undefined);
document.getElementById("apodDailyOpen").onclick=()=>{const u=apodDaily && bestImg(apodDaily); if(!u) return alert("No image"); window.open(u,"_blank","noreferrer");};
document.getElementById("apodDailyDL").onclick=()=>{const u=apodDaily && bestImg(apodDaily); if(!u) return alert("No image"); downloadFile(u, apodDaily.title||"apod", apodDailyMsg);};
document.getElementById("apodDailyFav").onclick=()=>{ if(apodDaily) toggleFav(apodDaily); };
document.getElementById("apodDailyShare").onclick=async()=>{
  if(!apodDaily) return;
  const url = bestImg(apodDaily) || apodDaily.url;
  const text = `${apodDaily.title} ‚Äî ${fmtDate(apodDaily.date)}`;
  try{
    if(navigator.share){ await navigator.share({title: apodDaily.title, text, url}); }
    else { await navigator.clipboard.writeText(url); alert("Image link copied to clipboard!"); }
  }catch{}
};

/* Random */
const apodRndMedia=document.getElementById("apodRndMedia"),
      apodRndInfo=document.getElementById("apodRndInfo"),
      apodRndTitle=document.getElementById("apodRndTitle"),
      apodRndExpl=document.getElementById("apodRndExpl"),
      apodRndMsg=document.getElementById("apodRndMsg"),
      apodRndAutoBtn=document.getElementById("apodRndAuto");
let apodRnd=null, rndTimer=null;

async function rerollAPOD(){
  apodRndInfo.textContent="Loading random‚Ä¶"; apodRndTitle.textContent=""; apodRndExpl.textContent=""; apodRndMedia.innerHTML=""; apodRndMsg.textContent="";
  try{
    const res=await apodFetch({count:1});
    const apod=Array.isArray(res)?res[0]:res;
    apodRnd=apod;
    renderMedia(apodRndMedia, apod);
    apodRndInfo.textContent=`${fmtDate(apod.date)} ‚Ä¢ ¬© NASA/APOD`;
    apodRndTitle.textContent=apod.title||"";
    apodRndExpl.textContent=apod.explanation||"";
  }catch(e){ apodRndInfo.textContent=e.message||"Failed"; }
}
document.getElementById("apodRndReroll").onclick=rerollAPOD;
document.getElementById("apodRndOpen").onclick=()=>{const u=apodRnd && bestImg(apodRnd); if(!u) return alert("No image"); window.open(u,"_blank","noreferrer");};
document.getElementById("apodRndDL").onclick=()=>{const u=apodRnd && bestImg(apodRnd); if(!u) return alert("No image"); downloadFile(u, apodRnd.title||"apod", apodRndMsg);};
document.getElementById("apodRndFav").onclick=()=>{ if(apodRnd) toggleFav(apodRnd); };

apodRndAutoBtn.onclick=()=>{
  if(rndTimer){ clearInterval(rndTimer); rndTimer=null; apodRndAutoBtn.textContent="Auto: Off"; }
  else { rndTimer=setInterval(rerollAPOD, 6000); apodRndAutoBtn.textContent="Auto: On"; }
};

/* Recent APODs */
const apodRecentGrid=document.getElementById("apodRecentGrid");
async function loadRecentAPOD(){
  apodRecentGrid.innerHTML="";
  try{
    const end = new Date(); const start = new Date(); start.setDate(end.getDate()-7);
    const fmt = d=>d.toISOString().slice(0,10);
    const data = await apodFetch({start_date: fmt(start), end_date: fmt(end), thumbs: "true"});
    const list = Array.isArray(data) ? data.reverse() : [];
    for(const ap of list){
      const div=document.createElement("div"); div.className="thumb";
      const src = ap.thumbnail_url || ap.hdurl || ap.url;
      div.innerHTML = `<img alt=""><div class="label">${ap.title||ap.date}</div>`;
      const img=div.querySelector("img"); img.src=src; img.alt=ap.title||ap.date;
      div.onclick=(e)=>{ if(e.altKey){ toggleFav(ap); } else { window.open(bestImg(ap)||ap.url, "_blank", "noreferrer"); } };
      apodRecentGrid.appendChild(div);
    }
  }catch(e){
    apodRecentGrid.innerHTML = `<div class="meta">Failed to load recent APODs: ${e.message}</div>`;
  }
}
document.getElementById("apodRecentReload").onclick=loadRecentAPOD;

/*** Favorites ***/
function toggleFav(apod){
  const idx=FAVS.findIndex(f=>f.date===apod.date);
  if(idx>=0) FAVS.splice(idx,1);
  else FAVS.unshift({date:apod.date,title:apod.title,media_type:apod.media_type,url:apod.url||null,hdurl:apod.hdurl||null,thumbnail_url:apod.thumbnail_url||null});
  LS.setFavs(FAVS);
  renderFavs();
  saveProfile(); // if signed in, sync to Firestore too
}
const favGrid=document.getElementById("favGrid");
function renderFavs(){
  favGrid.innerHTML="";
  for(const f of FAVS){
    const div=document.createElement("div"); div.className="thumb";
    const src = f.thumbnail_url || f.hdurl || f.url;
    div.innerHTML = `<img alt="thumb"><div class="label">${f.title || f.date}</div>`;
    const img=div.querySelector("img"); img.src=src; img.alt=f.title||f.date;
    div.onclick = (e)=>{ if(e.altKey){ // remove
        const i=FAVS.findIndex(x=>x.date===f.date); if(i>=0){ FAVS.splice(i,1); LS.setFavs(FAVS); renderFavs(); saveProfile(); }
      } else {
        const openUrl = f.hdurl || f.url || f.thumbnail_url;
        if(openUrl) window.open(openUrl, "_blank", "noreferrer");
      }
    };
    favGrid.appendChild(div);
  }
}
document.getElementById("favExport").onclick=()=>{ const blob=new Blob([JSON.stringify(FAVS,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="apod-favorites.json"; a.click(); URL.revokeObjectURL(url); };
document.getElementById("favImport").onclick=()=>{ const inp=document.createElement("input"); inp.type="file"; inp.accept="application/json"; inp.onchange=()=>{ const f=inp.files?.[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const arr=JSON.parse(rd.result); if(Array.isArray(arr)){ FAVS=arr; LS.setFavs(FAVS); renderFavs(); saveProfile(); } }catch(e){ alert("Import failed: "+e.message);} }; rd.readAsText(f); }; inp.click(); };
document.getElementById("favClear").onclick=()=>{ if(!confirm("Clear all favorites?")) return; FAVS=[]; LS.setFavs(FAVS); renderFavs(); saveProfile(); };
document.getElementById("favSync").onclick=()=>saveProfile(true);

/*** Mars Rover ***/
const marsMedia=document.getElementById("marsMedia"),
      marsInfo=document.getElementById("marsInfo");
async function loadMars(){
  marsMedia.innerHTML=""; marsInfo.textContent="Loading‚Ä¶";
  const rover=document.getElementById("rover").value.toLowerCase();
  const sol=parseInt(document.getElementById("sol").value||"0",10);
  const cam=document.getElementById("camera").value.trim();
  const u=new URL("https://api.nasa.gov/mars-photos/api/v1/rovers/"+rover+"/photos");
  u.searchParams.set("api_key",NASA_KEY);
  u.searchParams.set("sol", String(sol));
  if(cam) u.searchParams.set("camera", cam);
  const r=await fetch(u);
  if(!r.ok){ marsInfo.textContent="NASA Mars error: "+r.status; return; }
  const data=await r.json();
  if(!data.photos || !data.photos.length){ marsInfo.textContent="No photos for this combo. Try another sol/camera."; return; }
  const pick=data.photos[Math.floor(Math.random()*data.photos.length)];
  const img=new Image(); img.src=pick.img_src; img.alt="Mars photo";
  marsMedia.appendChild(img);
  marsInfo.textContent=`${pick.rover.name} ‚Ä¢ ${pick.camera.full_name} ‚Ä¢ Sol ${pick.sol} ‚Ä¢ ${pick.earth_date}`;
}
document.getElementById("marsLoad").onclick=loadMars;
document.getElementById("marsPrev").onclick=()=>{const s=document.getElementById("sol"); s.value=Math.max(0, (parseInt(s.value||"0",10)-1)); loadMars();};
document.getElementById("marsNext").onclick=()=>{const s=document.getElementById("sol"); s.value=(parseInt(s.value||"0",10)+1); loadMars();};

/*** EPIC ***/
const epicDate=document.getElementById("epicDate"),
      epicMedia=document.getElementById("epicMedia"),
      epicInfo=document.getElementById("epicInfo");
let epicList=[], epicIdx=0;
epicDate.value = (()=>{ const t=new Date(); t.setDate(t.getDate()-1); return t.toISOString().slice(0,10); })();
async function loadEPIC(){
  epicMedia.innerHTML=""; epicInfo.textContent="Loading‚Ä¶";
  const date=epicDate.value;
  const u=`https://api.nasa.gov/EPIC/api/natural/date/${date}?api_key=${NASA_KEY}`;
  const r=await fetch(u);
  if(!r.ok){ epicInfo.textContent="EPIC error: "+r.status; return; }
  epicList=await r.json();
  if(!Array.isArray(epicList) || !epicList.length){ epicInfo.textContent="No images for that date."; return; }
  epicIdx=0; renderEPIC();
}
function epicImageURL(rec){
  const d=new Date(rec.date);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return `https://api.nasa.gov/EPIC/archive/natural/${yyyy}/${mm}/${dd}/png/${rec.image}.png?api_key=${NASA_KEY}`;
}
function renderEPIC(){
  epicMedia.innerHTML="";
  const rec=epicList[epicIdx];
  const img=new Image(); img.loading="lazy"; img.src=epicImageURL(rec);
  epicMedia.appendChild(img);
  epicInfo.textContent=`${fmtDate(rec.date)} ‚Ä¢ ${epicIdx+1}/${epicList.length}`;
}
document.getElementById("epicLoad").onclick=loadEPIC;
document.getElementById("epicPrev").onclick=()=>{ if(epicList.length){ epicIdx=(epicIdx-1+epicList.length)%epicList.length; renderEPIC(); } };
document.getElementById("epicNext").onclick=()=>{ if(epicList.length){ epicIdx=(epicIdx+1)%epicList.length; renderEPIC(); } };
document.getElementById("epicDL").onclick=()=>{ if(!epicList.length) return alert("Load an EPIC date first."); const u=epicImageURL(epicList[epicIdx]); downloadFile(u, `EPIC_${epicList[epicIdx].image}`); };

/*** SpaceX ***/
const sxList=document.getElementById("sxList");
async function sxFetch(path){ const r=await fetch("https://api.spacexdata.com/v4/"+path); if(!r.ok) throw new Error("SpaceX error: "+r.status); return r.json(); }
function card(html){ const d=document.createElement("div"); d.innerHTML=html; d.className="card"; d.style.padding="12px"; return d; }
function launchCard(launch){
  const t=new Date(launch.date_utc).toLocaleString();
  return card(`<div class="content"><div class="row" style="justify-content:space-between"><strong>${launch.name}</strong><span class="meta">${t}</span></div><div class="meta">${launch.details||"No details."}</div>${launch.links?.webcast?`<a class="btn ghost" href="${launch.links.webcast}" target="_blank" rel="noreferrer">Webcast</a>`:""}</div>`);
}
document.getElementById("sxUpcoming").onclick=async()=>{ sxList.innerHTML=""; try{ const ups=await sxFetch("launches/upcoming"); ups.sort((a,b)=>new Date(a.date_utc)-new Date(b.date_utc)); ups.slice(0,5).forEach(l=>sxList.appendChild(launchCard(l))); }catch(e){ sxList.textContent=e.message; } };
document.getElementById("sxLatest").onclick=async()=>{ sxList.innerHTML=""; try{ const latest=await sxFetch("launches/latest"); sxList.appendChild(launchCard(latest)); }catch(e){ sxList.textContent=e.message; } };

/*** Weather (Open-Meteo + OSM) ***/
async function geocode(q){
  const u=new URL("https://nominatim.openstreetmap.org/search");
  u.searchParams.set("q", q); u.searchParams.set("format","json"); u.searchParams.set("limit","1");
  const r=await fetch(u, {headers:{"Accept":"application/json","User-Agent":"SpaceHub/1.0"}});
  if(!r.ok) throw new Error("Geocode error: "+r.status);
  const arr=await r.json(); return arr[0]||null;
}
async function openMeteo(lat, lon){
  const u=new URL("https://api.open-meteo.com/v1/forecast");
  u.searchParams.set("latitude", lat); u.searchParams.set("longitude", lon);
  u.searchParams.set("current_weather","true");
  u.searchParams.set("hourly","temperature_2m");
  const r=await fetch(u); if(!r.ok) throw new Error("Weather error: "+r.status);
  return r.json();
}
document.getElementById("wxGo").onclick=async()=>{
  const q=document.getElementById("wxQuery").value.trim()||"San Juan, PR";
  const info=document.getElementById("wxInfo"), now=document.getElementById("wxNow"), hourly=document.getElementById("wxHourly");
  info.textContent="Geocoding‚Ä¶"; now.textContent=""; hourly.textContent="";
  try{
    const g=await geocode(q);
    if(!g){ info.textContent="No match."; return; }
    info.textContent=`${g.display_name} (${parseFloat(g.lat).toFixed(3)}, ${parseFloat(g.lon).toFixed(3)})`;
    const wx=await openMeteo(g.lat, g.lon);
    if(wx.current_weather){
      now.textContent = `Now: ${wx.current_weather.temperature}¬∞C ‚Ä¢ Wind ${wx.current_weather.windspeed} km/h`;
    }
    if(wx.hourly?.time && wx.hourly?.temperature_2m){
      const next = wx.hourly.time.slice(0,12).map((t,i)=>`${t.slice(11,16)}: ${wx.hourly.temperature_2m[i]}¬∞C`);
      hourly.textContent = "Next hours: " + next.join("  ¬∑  ");
    }
  }catch(e){ info.textContent = e.message; }
};

/*** ISS live (Leaflet + wheretheiss.at) ***/
const issInfo=document.getElementById("issInfo");
let issMap, issMarker, issTimer=null;
function initISSMap(){
  if(issMap) return;
  issMap = L.map('issMap').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 6, attribution: '&copy; OpenStreetMap'
  }).addTo(issMap);
  issMarker = L.marker([0,0]).addTo(issMap).bindPopup('ISS');
}
async function fetchISS(){
  try{
    const r = await fetch("https://api.wheretheiss.at/v1/satellites/25544");
    const js = await r.json();
    const {latitude, longitude, velocity, visibility} = js;
    issMarker.setLatLng([latitude, longitude]);
    issInfo.textContent = `Lat ${latitude.toFixed(2)}, Lon ${longitude.toFixed(2)} ‚Ä¢ ${velocity.toFixed(1)} km/h ‚Ä¢ ${visibility}`;
  }catch(e){ issInfo.textContent = "ISS error: "+e.message; }
}
document.getElementById("issStart").onclick=()=>{ initISSMap(); fetchISS(); if(issTimer) clearInterval(issTimer); issTimer=setInterval(fetchISS,5000); };
document.getElementById("issStop").onclick=()=>{ if(issTimer) clearInterval(issTimer); issTimer=null; };

/*** Sky helper (Suncalc) ***/
document.getElementById("skyGo").onclick=async()=>{
  const where = document.getElementById("skyWhere").value.trim() || "San Juan, PR";
  const out = document.getElementById("skyOut");
  out.innerHTML = "Geocoding‚Ä¶";
  try{
    const g = await geocode(where);
    if(!g){ out.textContent="No match."; return; }
    const lat=+g.lat, lon=+g.lon;
    const now = new Date();
    const sun = SunCalc.getTimes(now, lat, lon);
    const moon = SunCalc.getMoonIllumination(now);
    const phasePct = Math.round(moon.fraction*100);
    const waxing = moon.phase < 0.5;
    out.innerHTML = `
      <div class="meta">${g.display_name}</div>
      <div class="title">Moon illumination: ${phasePct}% (${waxing?"waxing":"waning"})</div>
      <div class="meta">Sunrise: ${sun.sunrise.toLocaleTimeString()} &nbsp;‚Ä¢&nbsp; Sunset: ${sun.sunset.toLocaleTimeString()}</div>
    `;
  }catch(e){ out.textContent = e.message; }
};

/*** Unsplash ***/
let usPhoto=null;
document.getElementById("usRandom").onclick=async()=>{
  const q=document.getElementById("usQuery").value.trim()||"space";
  const media=document.getElementById("usMedia"), info=document.getElementById("usInfo"), credit=document.getElementById("usCredit");
  media.innerHTML=""; info.textContent="Loading‚Ä¶"; credit.textContent="";
  if(!UNSPLASH_KEY){ info.textContent="Set Unsplash key first."; return; }
  try{
    const u=new URL("https://api.unsplash.com/photos/random");
    u.searchParams.set("query", q); u.searchParams.set("orientation","landscape"); u.searchParams.set("client_id", UNSPLASH_KEY);
    const r=await fetch(u); if(!r.ok) throw new Error("Unsplash error: "+r.status);
    const p=await r.json(); usPhoto=p;
    const img=new Image(); img.loading="lazy"; img.src=p.urls.regular; img.alt=p.alt_description||"Unsplash photo";
    media.appendChild(img);
    info.textContent = `‚Äú${(p.description||p.alt_description||"Untitled")}"`;
    credit.innerHTML = `Photo by <a href="${p.user.links.html}?utm_source=SpaceHub&utm_medium=referral" target="_blank" rel="noreferrer">${p.user.name}</a> on Unsplash`;
  }catch(e){ info.textContent=e.message; }
};
document.getElementById("usDL").onclick=()=>{ if(!usPhoto) return alert("No photo"); const link = (usPhoto.links && usPhoto.links.download) ? (usPhoto.links.download + "?force=true") : (usPhoto.urls.full||usPhoto.urls.raw); downloadFile(link, "unsplash_photo"); };

/*** Keyboard shortcuts ***/
window.addEventListener("keydown",(e)=>{
  if(e.target.tagName === "INPUT") return;
  if(e.key.toLowerCase()==="r") document.getElementById("apodRndReroll").click();
  if(e.key.toLowerCase()==="f"){ const activeApodRnd = document.querySelector("#apod .grid2 section:nth-child(2)"); if(activeApodRnd) document.getElementById("apodRndFav").click(); }
  if(e.key.toLowerCase()==="d"){ const activeApodRnd = document.querySelector("#apod .grid2 section:nth-child(2)"); if(activeApodRnd) document.getElementById("apodRndDL").click(); else document.getElementById("apodDailyDL").click(); }
  if(e.key.toLowerCase()==="g") document.getElementById("toggleTheme").click();
});

/*** FIREBASE (Auth + Firestore) ‚Äî CLEAN ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* UPDATE: your real config here */
const firebaseConfig = {
  apiKey: "AIzaSyCjxG90jXrMW5BUK_pc-3C3pjupCdgQdIE",
  authDomain: "space-hub-9a0a4.firebaseapp.com",
  projectId: "space-hub-9a0a4",
  storageBucket: "space-hub-9a0a4.appspot.com",
  messagingSenderId: "325249598739",
  appId: "1:325249598739:web:14908beb6e9c3c123846e6"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: "select_account" });

/*** Account UI ***/
const acctStatus = document.getElementById("acctStatus");
const signInBtn = document.getElementById("signIn");
const signOutBtn = document.getElementById("signOut");

signInBtn.onclick = async () => {
  try { await signInWithPopup(auth, provider); }
  catch (e) {
    if (e.code === "auth/popup-blocked" || e.code === "auth/cancelled-popup-request") {
      await signInWithRedirect(auth, provider);
    } else { alert(e.message); console.error(e); }
  }
};
signOutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  USER = user || null;
  if (USER) {
    acctStatus.textContent = `Signed in as ${USER.displayName || USER.email || USER.uid}`;
    signInBtn.style.display = "none";
    signOutBtn.style.display = "inline-block";
    await loadProfile();
  } else {
    acctStatus.textContent = "Not signed in";
    signInBtn.style.display = "inline-block";
    signOutBtn.style.display = "none";
  }
});

/*** PROFILE LOAD/SAVE ***/
async function loadProfile(){
  if(!USER) return;
  try{
    const ref = doc(db, "users", USER.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      if (data.nasaKey){ NASA_KEY=data.nasaKey; LS.setNasaKey(NASA_KEY); nasaKeyLbl.textContent=NASA_KEY; }
      if (data.unsplashKey){ UNSPLASH_KEY=data.unsplashKey; LS.setUnsplashKey(UNSPLASH_KEY); unsplashKeyLbl.textContent=UNSPLASH_KEY; refreshUnsplashVisibility(); }
      if (Array.isArray(data.favs)){ FAVS=data.favs; LS.setFavs(FAVS); }
    } else {
      await setDoc(ref, { nasaKey: NASA_KEY, unsplashKey: UNSPLASH_KEY, favs: FAVS });
    }
  } catch (e){ console.warn("loadProfile:", e); }
  renderFavs();
}
async function saveProfile(force=false){
  if(!USER){ if(force) alert("Sign in to sync."); return; }
  try{
    const ref = doc(db, "users", USER.uid);
    await setDoc(ref, { nasaKey: NASA_KEY, unsplashKey: UNSPLASH_KEY, favs: FAVS }, { merge:true });
    if(force) alert("Synced!");
  }catch(e){ if(force) alert("Sync failed: "+e.message); }
}

/*** INIT ***/
renderFavs();
await loadAPODDaily();
await rerollAPOD();
await loadRecentAPOD();
</script>
</body>
</html>
